name: Build PRISM Platform

on:
    push:
        tags:
            - "v*"
    workflow_dispatch: # Allows manual trigger button

jobs:
    build:
        name: Build on ${{ matrix.os }}
        runs-on: ${{ matrix.os }}
        strategy:
            fail-fast: false
            matrix:
                os: [windows-latest, ubuntu-latest, macos-latest]

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.12"

            - name: Install Poetry
              run: pip install poetry

            - name: Install Dependencies
              run: make install

            # --- BUILD COMMAND (ALL OS) ---
            # We run the same command on all platforms now
            - name: Build with PyInstaller
              run: make build-worker

            # --- WINDOWS ZIP ---
            - name: Zip Windows Build
              if: matrix.os == 'windows-latest'
              continue-on-error: true
              run: |
                  # Use PowerShell to zip the executable created by PyInstaller
                  Compress-Archive -Path "dist\PRISM Platform.exe" -DestinationPath "dist\PRISM_Platform_Win.zip"

            # --- LINUX ZIP ---
            - name: Zip Linux Build
              if: matrix.os == 'ubuntu-latest'
              continue-on-error: true
              run: |
                  # Install libs just in case
                  sudo apt-get update && sudo apt-get install -y libegl1 libxkbcommon-x11-0 libdbus-1-3 x11-utils

                  cd dist
                  zip -r PRISM_Platform_Linux.zip "PRISM Platform"

            # --- MAC ZIP ---
            - name: Zip macOS Build
              if: matrix.os == 'macos-latest'
              continue-on-error: true
              run: |
                  cd dist
                  # Zip the FOLDER (not .app)
                  zip -r PRISM_Platform_Mac.zip "PRISM Platform"

            # --- UPLOAD ARTIFACTS ---
            - name: Upload Windows Zip
              if: matrix.os == 'windows-latest' && hashFiles('dist/PRISM_Platform_Win.zip') != ''
              continue-on-error: true
              uses: actions/upload-artifact@v4
              with:
                  name: PRISM-Windows
                  path: dist/PRISM_Platform_Win.zip

            - name: Upload Linux Zip
              if: matrix.os == 'ubuntu-latest' && hashFiles('dist/PRISM_Platform_Linux.zip') != ''
              continue-on-error: true
              uses: actions/upload-artifact@v4
              with:
                  name: PRISM-Linux
                  path: dist/PRISM_Platform_Linux.zip

            - name: Upload Mac Zip
              if: matrix.os == 'macos-latest' && hashFiles('dist/PRISM_Platform_Mac.zip') != ''
              continue-on-error: true
              uses: actions/upload-artifact@v4
              with:
                  name: PRISM-Mac
                  path: dist/PRISM_Platform_Mac.zip

    release:
        name: Create Release
        needs: build
        runs-on: ubuntu-latest
        if: startsWith(github.ref, 'refs/tags/')
        permissions:
            contents: write

        steps:
            - name: Download all artifacts
              uses: actions/download-artifact@v4
              with:
                  path: artifacts

            - name: Create Release
              uses: softprops/action-gh-release@v1
              with:
                  files: |
                      artifacts/PRISM-Windows/PRISM_Platform_Win.zip
                      artifacts/PRISM-Linux/PRISM_Platform_Linux.zip
                      artifacts/PRISM-Mac/PRISM_Platform_Mac.zip
                  fail_on_unmatched_files: false
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
