name: Build PRISM Platform

on:
    push:
        tags:
            - "v*"
    workflow_dispatch: # Allows manual trigger button

jobs:
    build:
        name: Build on ${{ matrix.os }}
        runs-on: ${{ matrix.os }}
        strategy:
            matrix:
                os: [windows-latest, ubuntu-latest, macos-latest]

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.10"

            - name: Install Poetry
              run: pip install poetry

            - name: Install Dependencies
              run: poetry install --no-root

            # --- BUILD COMMAND (ALL OS) ---
            # We run the same command on all platforms now
            - name: Build with PyInstaller
              run: poetry run pyinstaller PRISM_Platform.spec --noconfirm

            # --- WINDOWS ZIP ---
            - name: Zip Windows Build
              if: matrix.os == 'windows-latest'
              run: |
                  # Use PowerShell to zip the folder created by PyInstaller
                  Compress-Archive -Path "dist/PRISM Platform" -DestinationPath "dist/PRISM_Platform_Win.zip"

            # --- LINUX ZIP ---
            - name: Zip Linux Build
              if: matrix.os == 'ubuntu-latest'
              run: |
                  # Install libs just in case
                  sudo apt-get update && sudo apt-get install -y libegl1 libxkbcommon-x11-0 libdbus-1-3 x11-utils

                  cd dist
                  zip -r PRISM_Platform_Linux.zip "PRISM Platform"

            # --- MAC ZIP ---
            - name: Zip macOS Build
              if: matrix.os == 'macos-latest'
              run: |
                  cd dist
                  # Zip the FOLDER (not .app)
                  zip -r PRISM_Platform_Mac.zip "PRISM Platform"

            # --- UPLOAD ARTIFACTS ---
            - name: Upload Windows Zip
              if: matrix.os == 'windows-latest'
              uses: actions/upload-artifact@v4
              with:
                  name: PRISM-Windows
                  path: dist/PRISM_Platform_Win.zip

            - name: Upload Linux Zip
              if: matrix.os == 'ubuntu-latest'
              uses: actions/upload-artifact@v4
              with:
                  name: PRISM-Linux
                  path: dist/PRISM_Platform_Linux.zip

            - name: Upload Mac Zip
              if: matrix.os == 'macos-latest'
              uses: actions/upload-artifact@v4
              with:
                  name: PRISM-Mac
                  path: dist/PRISM_Platform_Mac.zip
