{% extends "layout.html" %}

{% block title %}Job Result - {{ job_request.job_id[:8] }}{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>Job Result</h2>
                <div>
                    <span class="badge badge-{% if job_request.status == 'completed' %}success{% elif job_request.status == 'failed' %}danger{% elif job_request.status == 'running' %}warning{% else %}secondary{% endif %} fs-6">
                        {{ job_request.status.title() }}
                    </span>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Job Details</h5>
                </div>
                <div class="card-body">
                    <dl class="row">
                        <dt class="col-sm-4">Job ID:</dt>
                        <dd class="col-sm-8"><code>{{ job_request.job_id }}</code></dd>

                        <dt class="col-sm-4">Config:</dt>
                        <dd class="col-sm-8">
                            {% if config %}
                            <strong>{{ config.config_name }}</strong>
                            <br><small class="text-muted">{{ config.config_id[:8] }}...</small>
                            {% else %}
                            <span class="text-muted">Config not found</span>
                            {% endif %}
                        </dd>

                        <dt class="col-sm-4">Created:</dt>
                        <dd class="col-sm-8">
                            <span id="created-time">{{ job_request.created_at.isoformat() }}</span>
                        </dd>

                        <dt class="col-sm-4">Updated:</dt>
                        <dd class="col-sm-8">
                            <span id="updated-time">{{ job_request.updated_at.isoformat() }}</span>
                        </dd>
                    </dl>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Target Devices</h5>
                </div>
                <div class="card-body">
                    {% for device in devices %}
                    <div class="d-flex justify-content-between align-items-center mb-2 p-2 border rounded">
                        <div>
                            <strong>{{ device.device_name }}</strong>
                            {% if device.device_uuid %}
                            <br><small class="text-muted">{{ device.device_uuid }}</small>
                            {% endif %}
                        </div>
                        <div>
                                <span class="badge badge-secondary" id="device-status-{{ device.device_uuid }}">
                                    Pending
                                </span>
                        </div>
                    </div>
                    {% endfor %}

                    {% if not devices %}
                    <p class="text-muted">Device information not available</p>
                    <div class="mt-2">
                        <strong>Device Serials:</strong>
                        <ul class="list-unstyled mt-1">
                            {% for serial in device_serials %}
                            <li><code>{{ serial }}</code></li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    {% if job_request.result_summary %}
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Result Summary</h5>
                </div>
                <div class="card-body">
                    <pre>{{ job_request.result_summary }}</pre>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        Live Updates
                        <small class="text-muted ms-2" id="connection-status">Connecting...</small>
                    </h5>
                </div>
                <div class="card-body">
                    <div id="updates-log" style="max-height: 400px; overflow-y: auto;">
                        <p class="text-muted">Waiting for updates...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Generated Traces</h5>
                </div>
                <div class="card-body" id="traces-section">
                    <p class="text-muted">No traces generated yet.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Format timestamps to local timezone
    function formatTimestamp(isoString) {
        const date = new Date(isoString);
        return date.toLocaleString();
    }

    // Update timestamps on page load
    document.addEventListener('DOMContentLoaded', function () {
        const createdSpan = document.getElementById('created-time');
        const updatedSpan = document.getElementById('updated-time');

        if (createdSpan) {
            createdSpan.textContent = formatTimestamp(createdSpan.textContent);
        }
        if (updatedSpan) {
            updatedSpan.textContent = formatTimestamp(updatedSpan.textContent);
        }
    });

    // Server-Sent Events for live updates with auto-reconnect
    let eventSource = null;
    let reconnectAttempts = 0;
    const maxReconnectAttempts = 10;
    const updatesLog = document.getElementById('updates-log');
    const connectionStatus = document.getElementById('connection-status');
    const tracesSection = document.getElementById('traces-section');

    function connectSSE() {
        if (eventSource) {
            eventSource.close();
        }

        eventSource = new EventSource('/jobs/{{ job_request.job_id }}/stream');

        eventSource.onopen = function () {
            connectionStatus.textContent = 'Connected';
            connectionStatus.className = 'text-success ms-2';
            reconnectAttempts = 0;
        };

        eventSource.onerror = function (error) {
            console.error('SSE Error:', error);
            connectionStatus.textContent = 'Connection Lost - Reconnecting...';
            connectionStatus.className = 'text-warning ms-2';

            eventSource.close();

            // Attempt to reconnect with exponential backoff
            if (reconnectAttempts < maxReconnectAttempts) {
                reconnectAttempts++;
                const delay = Math.min(1000 * Math.pow(2, reconnectAttempts), 30000);
                console.log(`Reconnecting in ${delay}ms (attempt ${reconnectAttempts})`);
                setTimeout(connectSSE, delay);
            } else {
                connectionStatus.textContent = 'Connection Failed - Refresh Page';
                connectionStatus.className = 'text-danger ms-2';
            }
        };

        eventSource.onmessage = function (event) {
            try {
                const data = JSON.parse(event.data);

                if (data.type === 'connected') {
                    updatesLog.innerHTML = '<p class="text-success">Connected to live updates</p>';
                    return;
                }

                if (data.type === 'heartbeat') {
                    return;
                }

                // Handle job updates
                const timestamp = new Date(data.timestamp).toLocaleString();
                const updateHtml = `
                    <div class="alert alert-info alert-sm mb-2">
                        <div class="d-flex justify-content-between">
                            <strong>${data.device_serial}</strong>
                            <small>${timestamp}</small>
                        </div>
                        <div>Status: <span class="badge badge-${data.status === 'completed' ? 'success' : data.status === 'failed' ? 'danger' : 'warning'}">${data.status}</span></div>
                        ${data.message ? `<div class="mt-1">${data.message}</div>` : ''}
                        ${data.trace_id ? `<div class="mt-1"><a href="/traces/${data.trace_id}" class="btn btn-sm btn-outline-primary">View Trace</a></div>` : ''}
                    </div>
                `;

                if (updatesLog.querySelector('.text-muted')) {
                    updatesLog.innerHTML = '';
                }

                updatesLog.insertAdjacentHTML('afterbegin', updateHtml);

                // Update device status badge
                const deviceStatus = document.getElementById(`device-status-${data.device_serial}`);
                if (deviceStatus) {
                    deviceStatus.textContent = data.status.charAt(0).toUpperCase() + data.status.slice(1);
                    deviceStatus.className = `badge badge-${data.status === 'completed' ? 'success' : data.status === 'failed' ? 'danger' : 'warning'}`;
                }

                // Update traces section if trace_id is provided
                if (data.trace_id) {
                    if (tracesSection.querySelector('.text-muted')) {
                        tracesSection.innerHTML = '<div class="row" id="traces-grid"></div>';
                    }

                    const tracesGrid = document.getElementById('traces-grid');
                    const traceCard = `
                        <div class="col-md-4 mb-3">
                            <div class="card">
                                <div class="card-body">
                                    <h6 class="card-title">${data.device_serial}</h6>
                                    <p class="card-text small">Generated: ${timestamp}</p>
                                    <a href="/traces/${data.trace_id}" class="btn btn-primary btn-sm">View Trace</a>
                                </div>
                            </div>
                        </div>
                    `;
                    tracesGrid.insertAdjacentHTML('beforeend', traceCard);
                }

            } catch (e) {
                console.error('Error parsing SSE data:', e);
            }
        };
    }

    // Start connection
    connectSSE();

    // Clean up on page unload
    window.addEventListener('beforeunload', function () {
        if (eventSource) {
            eventSource.close();
        }
    });
</script>
{% endblock %}
