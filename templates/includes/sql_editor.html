<link rel="stylesheet" data-name="vs/editor/editor.main"
      href="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.27.0/min/vs/editor/editor.main.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.27.0/min/vs/loader.min.js"></script>
<script>
    let editor = null;

    function initializeMonacoEditor() {
        try {
            // Check if the editor container exists
            const editorContainer = document.getElementById('editor');
            const textareaElement = document.getElementById('query_text');

            if (!editorContainer) {
                console.error('Editor container not found');
                return;
            }

            if (!textareaElement) {
                console.error('Textarea element not found');
                return;
            }

            // Configure Monaco paths
            require.config({
                paths: {
                    'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.27.0/min/vs'
                }
            });

            // Load Monaco Editor
            require(['vs/editor/editor.main'], function () {
                try {
                    // Get the initial value from textarea
                    const initialValue = textareaElement.value || '';

                    console.log("Text:", initialValue)

                    // Create the editor
                    editor = monaco.editor.create(editorContainer, {
                        value: initialValue,
                        language: 'sql',
                        theme: 'vs-dark',
                        automaticLayout: true,
                        minimap: {
                            enabled: false
                        },
                        scrollBeyondLastLine: false,
                        fontSize: 14,
                        lineNumbers: 'on'
                    });

                    console.log('Monaco Editor initialized successfully');

                    // Update the hidden textarea whenever content changes
                    editor.onDidChangeModelContent(function (e) {
                        textareaElement.value = editor.getValue();
                    });

                } catch (editorError) {
                    console.error('Error creating Monaco Editor:', editorError);
                    // Fallback: show the textarea if Monaco fails
                    textareaElement.style.display = 'block';
                }
            }, function (err) {
                console.error('Error loading Monaco Editor modules:', err);
                // Fallback: show the textarea if Monaco fails to load
                document.getElementById('query_text').style.display = 'block';
            });

        } catch (error) {
            console.error('Error in initializeMonacoEditor:', error);
            // Fallback: show the textarea
            document.getElementById('query_text').style.display = 'block';
        }
    }

    // Multiple initialization strategies for better compatibility
    function setupEditor() {
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function () {
                setTimeout(initializeMonacoEditor, 100);
            });
        } else {
            // DOM is already ready
            setTimeout(initializeMonacoEditor, 100);
        }
    }

    // Form submission handler
    document.addEventListener('DOMContentLoaded', function () {
        const form = document.querySelector('form');
        if (form) {
            form.addEventListener('submit', function (e) {
                if (editor) {
                    // Update textarea with current editor value
                    document.getElementById('query_text').value = editor.getValue();
                }
            });
        }
    });

    // Initialize the editor
    setupEditor();
</script>
<style>
    #query_text {
        display: none; /* Hide the original textarea */
    }

    #editor {
        width: 100%;
        height: 400px; /* Set explicit height */
    }
</style>